<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FSR Live • Austranet × Epigonal</title>
<style>
:root{
  --bg:#0f1220; --fg:#eef1ff; --muted:#9aa3b2; --accent:#6aa6ff; --card:#171c2b;
  --bar:#2a3248; --good:#33d69f; --bad:#ef5f6b; --amber:#ffb300;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,Segoe UI,Roboto}

/* LANDING */
#landing{min-height:100dvh;display:grid;place-items:center;padding:36px;position:relative;overflow:hidden}
#bgfx{position:absolute;inset:0;width:100%;height:100%;display:block}
.hero{position:relative;z-index:1;max-width:1000px;width:100%;display:flex;flex-direction:column;align-items:center;text-align:center;gap:20px}
.brandline{display:inline-block;font-weight:900;letter-spacing:.4px;line-height:1.05;
  background:linear-gradient(90deg,#bcd1ff,#e7ebff 40%,#bcd1ff 80%);-webkit-background-clip:text;background-clip:text;color:transparent;
  filter:drop-shadow(0 10px 30px rgba(0,0,0,.35))}
.brandTop{font-size:clamp(28px,6vw,56px)}
.brandMid{font-size:clamp(16px,3vw,22px);color:#cfd6ea;opacity:.92;margin-top:-4px}
.card-landing{background:linear-gradient(180deg,rgba(23,28,43,.9),rgba(23,28,43,.6));backdrop-filter:blur(6px);
  border:1px solid #293048;border-radius:16px;padding:12px 14px;display:inline-flex;gap:10px;align-items:center}
.card-landing .dot{width:8px;height:8px;border-radius:999px;background:var(--good)}
.actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:6px}
button{background:var(--accent);color:#0b1020;border:0;padding:12px 18px;border-radius:14px;font-weight:700;cursor:pointer;transition:transform .15s,filter .15s}
button:hover{filter:brightness(1.05)} button:active{transform:translateY(1px)}
button.secondary{background:#24304a;color:var(--fg)}
.small{font-size:13px;color:var(--muted)}
.footer-landing{position:fixed;left:0;right:0;bottom:14px;text-align:center;color:var(--muted);font-size:12px;padding:0 10px}

/* LOGIN */
#loginCard{display:none;gap:12px;flex-direction:column;align-items:stretch;width:min(440px,92vw);
  background:linear-gradient(180deg,rgba(23,28,43,.92),rgba(23,28,43,.72));backdrop-filter:blur(6px);
  border:1px solid #293048;border-radius:16px;padding:18px;margin-top:10px;box-shadow:0 20px 50px rgba(0,0,0,.35)}
#loginCard h3{margin:0 0 6px}
.input{display:flex;flex-direction:column;gap:6px;text-align:left}
.label{color:#b9c2d6;text-transform:uppercase;letter-spacing:.08em;font-size:12px}
.input-row{display:flex;gap:8px;align-items:center}
.input-row input[type=text], .input-row input[type=password]{flex:1}
input[type=text],input[type=password],input[type=number]{background:#0d1220;border:1px solid #2b3348;color:#eef1ff;padding:12px;border-radius:10px;outline:none}
#caps{color:#ffd54a;display:none;font-size:12px}
.error{color:#ef5f6b;font-size:13px;min-height:18px}
.hint{font-size:12px;color:var(--muted);text-align:center;margin-top:2px}

/* APP */
#app{display:none}
.container{max-width:1200px;margin:36px auto;padding:0 16px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap}
h1{font-size:22px;margin:0;color:#fff;letter-spacing:.3px}
.badge{font-size:12px;color:var(--muted)}
.panel{display:flex;gap:10px;flex-wrap:wrap;align-items:center;background:var(--card);padding:12px;border-radius:14px}
.help{color:var(--muted);font-size:13px}

/* Estado global (header) */
.status{display:flex;align-items:center;gap:8px;background:#12182a;border:1px solid #262f47;border-radius:10px;padding:6px 10px;font-size:13px}
.dot{width:10px;height:10px;border-radius:999px;background:var(--bad)}
.dot.ok{background:var(--good)}

/* Nav principal */
.nav{display:flex;gap:8px;flex-wrap:wrap}
.nav button{background:#24304a;color:#e6ecff}
.nav button.active{background:#6aa6ff;color:#0b1020}

/* 2×2 grids */
.grid2x2{display:grid;gap:16px;grid-template-columns:repeat(2,minmax(0,1fr));margin-top:16px}
@media (max-width: 820px){ .grid2x2{grid-template-columns:1fr} }

.card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
.value{font-size:42px;font-weight:800}
.sub{color:var(--muted);margin-top:6px}
.bar{height:16px;background:var(--bar);border-radius:999px;overflow:hidden;margin-top:6px}
.fill{height:100%;width:0%;background:linear-gradient(90deg,#74d0ff,#6aa6ff);transition:width .12s}
.row{display:flex;justify-content:space-between;gap:8px;margin-top:8px}
.kpi{background:#12182a;border:1px solid #262f47;border-radius:10px;padding:6px 10px;font-size:13px}
.kpi b{font-weight:700}

/* charts */
.chart{background:var(--card);border-radius:16px;padding:12px}
.chart .label{color:var(--muted);text-transform:uppercase;letter-spacing:.08em;font-size:12px;margin-bottom:6px}
canvas{display:block;width:100%;height:auto;border-radius:10px;background:#151b2d}
.chart canvas{margin:0 auto;}

/* ===== VAL MATRIX (Mapa) ===== */
.vals-matrix{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:6px 0 10px}
.vals-matrix div{background:#12182a;border:1px solid #262f47;border-radius:10px;padding:10px 12px;font-weight:700;display:flex;justify-content:space-between;align-items:center}
.vals-matrix span{ color:var(--muted); font-weight:600 }
.vals-matrix b{ font-size:18px }

/* heatmap */
#heatmap{display:none;margin-top:16px}
#heat{display:block;width:100%;height:auto;background:#151b2d;border-radius:14px;border:1px solid #262f47;margin:0 auto}

/* ===== PERFIL ===== */
#profile{display:none}
.grid3{display:grid;grid-template-columns:2fr 1fr;gap:16px}
@media (max-width: 980px){ .grid3{grid-template-columns:1fr} }
.badge-ok{color:#0f1f0f;background:rgba(51,214,159,.18);border:1px solid rgba(51,214,159,.35);padding:3px 8px;border-radius:999px;font-size:12px}
.badge-warn{color:#2a1a00;background:rgba(255,179,0,.18);border:1px solid rgba(255,179,0,.35);padding:3px 8px;border-radius:999px;font-size:12px}
.badge-bad{color:#2a0b10;background:rgba(239,95,107,.18);border:1px solid rgba(239,95,107,.35);padding:3px 8px;border-radius:999px;font-size:12px}

.inline-row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:6px}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;border:1px solid transparent}
.pill.warn{color:#2a1a00;background:rgba(255,179,0,.18);border-color:rgba(255,179,0,.35)}
.pill.alarm{color:#2a0b10;background:rgba(239,95,107,.24);border-color:rgba(239,95,107,.7)}

.mbar{position:relative;height:14px;background:#1a2234;border:1px solid #2a3147;border-radius:999px;overflow:hidden}
.mbar .inner{height:100%;width:50%}
.mbar .left{background:linear-gradient(90deg,#2a3248, var(--amber))}
.mbar .right{background:linear-gradient(90deg,var(--amber), #2a3248)}
.mbar .front{background:linear-gradient(90deg,#2a3248, var(--amber))}
.mbar .back{background:linear-gradient(90deg,var(--amber), #2a3248)}
.mbar .center{position:relative;height:100%}
.mbar .tick{position:absolute;top:0;bottom:0;width:2px;background:#fff2;border-radius:1px;left:50%}

#cop{display:block;width:100%;height:auto;background:#151b2d;border-radius:12px;border:1px solid #262f47}

/* Parpadeo evidente */
@keyframes blink {
  0%,49%{ filter:none; box-shadow:0 0 0 rgba(239,95,107,0); }
  50%,100%{ filter:brightness(1.6) saturate(1.6); box-shadow:0 0 18px rgba(239,95,107,.9); }
}
.blink{ animation:blink .7s linear infinite; }

/* ===== GUÍA ===== */
#guide{display:none;margin-top:16px}
.guide-grid{display:grid;grid-template-columns:2fr 1.1fr;gap:16px}
@media (max-width: 900px){ .guide-grid{grid-template-columns:1fr} }
.guide-title{font-size:20px;font-weight:700;margin-bottom:4px}
.guide-sub{font-size:14px;color:var(--muted);margin-bottom:12px}
.guide-list{margin:0;padding-left:18px;font-size:14px;color:#d7def4}
.guide-list li{margin-bottom:6px}
.guide-pill{display:inline-flex;align-items:center;gap:6px;padding:4px 9px;border-radius:999px;border:1px solid rgba(106,166,255,.4);background:rgba(106,166,255,.12);font-size:12px;color:#ced7ff}

/* LOGO */
#cornerLogo{position:fixed;right:18px;top:18px;width:120px;height:auto;opacity:.95;filter:drop-shadow(0 6px 20px rgba(0,0,0,.35));display:none;pointer-events:none}
@media (max-width:560px){ #cornerLogo{width:90px} }
</style>
</head>
<body>

<!-- PORTADA -->
<section id="landing" aria-label="Portada">
  <canvas id="bgfx" aria-hidden="true"></canvas>
  <div class="hero">
    <div class="brandline brandTop">Austranet × Epigonal</div>
    <div class="brandline brandMid">colaboración para medición en tiempo real</div>

    <div class="card-landing" aria-live="polite">
      <div class="dot" aria-hidden="true"></div>
      <div class="small">Listo para conectar con tu ESP32 (WebSocket)</div>
    </div>

    <div class="actions">
      <button id="btnShowLogin" aria-label="Abrir formulario de inicio de sesión">Entrar</button>
      <button id="btnDemo" class="secondary" aria-label="Ver demostración en vivo">Ver demo</button>
    </div>

    <div id="loginCard" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <h3 id="loginTitle">Inicio de sesión</h3>
      <div class="input">
        <label class="label" for="user">Usuario</label>
        <div class="input-row">
          <input id="user" type="text" placeholder="Matias / Manuel / Gabriel / Gabriela" autocomplete="username" aria-required="true"/>
        </div>
      </div>
      <div class="input">
        <label class="label" for="pass">Contraseña <span id="caps" aria-live="polite">(Bloq Mayús activo)</span></label>
        <div class="input-row">
          <input id="pass" type="password" placeholder="igual al nombre" autocomplete="current-password" aria-required="true"/>
        </div>
      </div>
      <div id="loginErr" class="error" aria-live="assertive"></div>
      <button id="btnLogin" aria-label="Ingresar">Ingresar</button>
      <div class="hint">Pulsa <b>Enter</b> para enviar</div>
    </div>

    <div class="small">Podrás cambiar la IP y el rango visual dentro del panel.</div>
  </div>
  <div class="footer-landing">© Austranet × Epigonal — UI experimental</div>
</section>

<!-- LOGO -->
<img id="cornerLogo" alt="Logo Austranet"/>

<!-- APP -->
<section id="app" aria-labelledby="appTitle">
  <div class="container">
    <header>
      <div>
        <h1 id="appTitle">FSR Live <span class="badge">suite</span></h1>
        <div class="help">Navega: Perfil • Dashboard • Mapa • Guía</div>
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <div class="status" title="Estado de conexión">
          <div id="dot" class="dot" aria-hidden="true"></div>
          <div id="statusTxt" aria-live="polite">Desconectado</div>
        </div>

        <!-- NAV -->
        <div class="nav" role="tablist" aria-label="Navegación principal">
          <button id="btnProfile"   class="secondary active" role="tab" aria-selected="true">Perfil</button>
          <button id="btnDashboard" class="secondary"        role="tab" aria-selected="false">Dashboard</button>
          <button id="btnHeatmap"   class="secondary"        role="tab" aria-selected="false">Mapa</button>
          <button id="btnGuide"     class="secondary"        role="tab" aria-selected="false">Guía</button>
        </div>

        <button id="btnLogout" class="secondary" aria-label="Cerrar sesión">Salir</button>
      </div>
    </header>

    <!-- Controles -->
    <div class="panel" role="region" aria-label="Controles de conexión">
      <input id="ip" type="text" placeholder="IP de la ESP (ej: 172.20.10.5)" inputmode="numeric" pattern="^\\d+\\.\\d+\\.\\d+\\.\\d+$" aria-label="Dirección IP de la ESP32"/>
      <button id="btnConnect" aria-label="Conectar a la ESP32">Conectar</button>
      <button id="btnDisconnect" class="secondary" disabled aria-label="Desconectar de la ESP32">Desconectar</button>
      <div class="toggle" style="margin-left:auto;gap:12px">
        <label class="help" for="maxkg">Max kg (escala visual):</label>
        <input id="maxkg" type="number" step="0.1" min="0.1" value="10.0" style="width:100px" aria-label="Escala visual máximo en kilogramos"/>
      </div>
    </div>

    <!-- PERFIL -->
    <section id="profile" aria-label="Perfil postural">
      <div class="grid3">
        <!-- Card Conclusión -->
        <div class="card" id="profileCard">
          <div class="label">Conclusión</div>
          <div id="conclusion" class="value" style="font-size:34px;margin-top:8px">Sin carga</div>
          <div id="conclusionBadge" class="sub" style="margin-top:4px"></div>

          <!-- Texto compacto + alarma/contador -->
          <div class="inline-row">
            <span id="inlineLRFB" class="sub">Centro • Centro</span>
            <span id="fwdTimerPill" class="pill" style="display:none"></span>
          </div>

          <div class="row" style="margin-top:14px">
            <div style="flex:1">
              <div class="label">Balance izquierda ↔ derecha</div>
              <div class="mbar"><div id="barLR" class="inner left" style="width:50%"></div><div class="tick"></div></div>
              <div class="sub" id="txtLR">—</div>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <div style="flex:1">
              <div class="label">Balance atrás ↔ adelante</div>
              <div class="mbar"><div id="barFB" class="inner front" style="width:50%"></div><div class="tick"></div></div>
              <div class="sub" id="txtFB">—</div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="kpi">Carga total: <b id="kpiTotal">0.00</b> kg</div>
            <div class="kpi">Estabilidad: <b id="kpiStab">—</b></div>
          </div>
        </div>

        <!-- Card CoP -->
        <div class="card">
          <div class="label">Centro de presión (CoP)</div>
          <canvas id="cop" width="380" height="380"></canvas>
          <div class="sub" style="margin-top:6px">• Punto blanco = CoP relativo • Cuadrantes = sensores (S1↖ S2↗ S3↙ S4↘)</div>
        </div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" aria-label="Dashboard general">
      <div id="cards" class="grid2x2"></div>
      <div id="charts" class="grid2x2"></div>
    </section>

    <!-- MAPA -->
    <section id="heatmap" aria-label="Mapa 2×2 de cuadrados independientes">
      <div class="chart card">
        <div class="label">Lecturas (matriz)</div>
        <div class="vals-matrix">
          <div><span>S1</span><b><span id="vS1">0.00</span> kg</b></div>
          <div><span>S2</span><b><span id="vS2">0.00</span> kg</b></div>
          <div><span>S3</span><b><span id="vS3">0.00</span> kg</b></div>
          <div><span>S4</span><b><span id="vS4">0.00</span> kg</b></div>
        </div>

        <div class="label" style="margin-top:4px">Mapa (4 cuadrados independientes)</div>
        <canvas id="heat"></canvas>
        <div class="sub" style="margin-top:8px">Cada cuadrado refleja su sensor de forma independiente. Etiquetas externas y legibles.</div>
      </div>
    </section>

    <!-- GUÍA -->
    <section id="guide" aria-label="Guía de postura y ergonomía">
      <div class="card">
        <div class="guide-title">Guía rápida para sentarte mejor</div>
        <div class="guide-sub">
          Esta sección no mide ni vibra: solo te da contexto para interpretar lo que ves en <b>Perfil</b> y <b>Mapa</b>
          y ayudarte a construir un hábito de postura más estable.
        </div>
        <div class="guide-grid">
          <!-- Columna izquierda: cómo sentarse -->
          <div class="card" style="background:#111728;">
            <div class="guide-pill">Paso a paso</div>
            <h3 style="margin:10px 0 6px;font-size:17px;">1. Pies y apoyo de base</h3>
            <ul class="guide-list">
              <li>Apoya <b>ambos pies</b> en el suelo o en un apoyo estable.</li>
              <li>Evita cruzar las piernas mucho tiempo: suele desplazar el peso hacia un lado.</li>
              <li>Piensa en una base “ancha”: pies separados al ancho de caderas.</li>
            </ul>

            <h3 style="margin:10px 0 6px;font-size:17px;">2. Pelvis y columna</h3>
            <ul class="guide-list">
              <li>Siéntate sobre los <b>huesos isquiones</b> (no sobre la zona baja de la espalda).</li>
              <li>Imagina que la columna se alarga hacia arriba, sin “forzar” el pecho.</li>
              <li>Evita estar mucho tiempo “derritido” hacia adelante: es lo que la app marcará como <b>muy adelante</b>.</li>
            </ul>

            <h3 style="margin:10px 0 6px;font-size:17px;">3. Cabeza, hombros y pantalla</h3>
            <ul class="guide-list">
              <li>La cabeza debería estar aproximadamente sobre los hombros, no muy adelantada.</li>
              <li>Relaja hombros: ni encogidos hacia las orejas, ni excesivamente hacia atrás.</li>
              <li>Ajusta la pantalla para no tener que empujar el tronco hacia adelante para verla.</li>
            </ul>
          </div>

          <!-- Columna derecha: beneficios + datos -->
          <div class="card" style="background:#111728;">
            <div class="guide-pill">Por qué importa</div>
            <h3 style="margin:10px 0 6px;font-size:17px;">Beneficios de repartir mejor el peso</h3>
            <ul class="guide-list">
              <li>Una postura más centrada suele asociarse a <b>menos fatiga muscular</b> a lo largo del día.</li>
              <li>Reducir el tiempo en posturas extremas (muy adelante o muy a un lado) disminuye la carga repetida en la zona lumbar.</li>
              <li>Pequeños ajustes mantenidos en el tiempo tienen más impacto que cambios bruscos de un solo día.</li>
            </ul>

            <h3 style="margin:12px 0 6px;font-size:17px;">Cómo usar esta app junto a la guía</h3>
            <ul class="guide-list">
              <li>Primero, siéntate como “te parece cómodo” y mira el <b>Perfil</b>: ¿estás centrado, adelante, atrás?</li>
              <li>Haz un ajuste pequeño (por ejemplo, acercar la espalda al respaldo) y observa cómo cambia el centro de presión.</li>
              <li>Si ves con frecuencia el aviso de <b>“Muy adelante”</b> y la vibración, úsalo como recordatorio para volver al rango más neutro.</li>
              <li>La idea no es estar rígido, sino <b>oscilar alrededor de una postura más equilibrada</b>.</li>
            </ul>

            <p class="guide-sub" style="margin-top:12px;">
              Esta guía no reemplaza recomendaciones médicas ni de kinesiología.  
              Si tienes dolor o molestias persistentes, es buena idea consultar con un profesional.
            </p>
          </div>
        </div>
      </div>
    </section>

    <footer style="margin-top:18px">Tip: navega con Perfil • Dashboard • Mapa • Guía.</footer>
  </div>
</section>

<script>
/* ===== Const/UI ===== */
const LOGO_PATH = "assets/Austranet-Logo.png";
const VALID_USERS = new Set(["Matias","Manuel","Gabriel","Gabriela"]);
const EMA_ALPHA = 0.25;
const DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
const HEAT_MAX_PX  = 720;
const CHART_MAX_PX = 640;
const HEAT_PAD = 14;
const HEAT_RADIUS = 14;
const TILE_GAP = 14;
const TILE_RADIUS = 14;
const LABEL_TOP = 30;
const LABEL_BOTTOM = 54;

/* FX landing (ajustables) */
const FX_SPEED = 2.4;
const FX_DRIFT = 2;

/* Refs DOM */
const landing = document.getElementById('landing');
const bgfx = document.getElementById('bgfx');
const app = document.getElementById('app');
const cornerLogo = document.getElementById('cornerLogo');

const btnShowLogin = document.getElementById('btnShowLogin');
const btnDemo = document.getElementById('btnDemo');
const loginCard = document.getElementById('loginCard');
const userEl = document.getElementById('user');
const passEl = document.getElementById('pass');
const btnLogin = document.getElementById('btnLogin');
const loginErr = document.getElementById('loginErr');
const capsEl = document.getElementById('caps');

const ipEl = document.getElementById('ip');
const btnConnect = document.getElementById('btnConnect');
const btnDisconnect = document.getElementById('btnDisconnect');
const maxkgEl = document.getElementById('maxkg');
const statusTxt = document.getElementById('statusTxt');
const dot = document.getElementById('dot');

/* Nav */
const btnProfile   = document.getElementById('btnProfile');
const btnDashboard = document.getElementById('btnDashboard');
const btnHeatmap   = document.getElementById('btnHeatmap');
const btnGuide     = document.getElementById('btnGuide');

const profileSec   = document.getElementById('profile');
const dashboardSec = document.getElementById('dashboard');
const heatmapSection = document.getElementById('heatmap');
const guideSec     = document.getElementById('guide');

/* Dashboard canvases */
const cardsEl = document.getElementById('cards');
const chartsEl = document.getElementById('charts');

/* Heatmap */
const heatCvs = document.getElementById('heat');
const vS1 = document.getElementById('vS1');
const vS2 = document.getElementById('vS2');
const vS3 = document.getElementById('vS3');
const vS4 = document.getElementById('vS4');

/* Perfil */
const conclusionEl = document.getElementById('conclusion');
const conclusionBadgeEl = document.getElementById('conclusionBadge');
const barLR = document.getElementById('barLR');
const barFB = document.getElementById('barFB');
const txtLR = document.getElementById('txtLR');
const txtFB = document.getElementById('txtFB');
const kpiTotal = document.getElementById('kpiTotal');
const kpiStab = document.getElementById('kpiStab');
const copCvs = document.getElementById('cop');
let copCtx = copCvs.getContext('2d');

const inlineLRFB = document.getElementById('inlineLRFB');
const fwdTimerPill = document.getElementById('fwdTimerPill');
const profileCard = document.querySelector('#profile .grid3 .card:first-child');

/* Estado */
let currentView = 'profile'; // perfil por defecto
const N = 4;
let ws = null, demoRAF = 0, vibOn = false;
let maxKg = parseFloat(localStorage.getItem('maxKg') || maxkgEl.value);
if (!isFinite(maxKg) || maxKg <= 0) maxKg = 10.0;
maxkgEl.value = maxKg.toFixed(1);
const savedIp = localStorage.getItem('espIp'); if (savedIp) ipEl.value = savedIp;

/* Sensores + buffers */
const sensors = Array.from({length:N}).map((_,i)=>({
  id:i, label:`S${i+1}`, kg:0, vkg:0,
  min:Infinity, max:-Infinity, samples:0, lastHzTs:0,
  buf:new Array(200).fill(0), W:0,H:0, ctx:null, cvs:null,
  dRecent:[]
}));

function setStatus(ok,msg){
  dot.className = 'dot' + (ok ? ' ok' : '');
  statusTxt.textContent = msg || (ok?'Conectado':'Desconectado');
  btnConnect.disabled = ok; btnDisconnect.disabled = !ok;
}

/* ===== Canvas helper ===== */
function setupCanvas(cvs, cssW, cssH){
  cvs.style.width = cssW + 'px';
  cvs.style.height = cssH + 'px';
  cvs.width  = Math.round(cssW * DPR);
  cvs.height = Math.round(cssH * DPR);
  const ctx = cvs.getContext('2d', {alpha:true});
  ctx.setTransform(DPR,0,0,DPR,0,0);
  return {ctx, W: cssW, H: cssH};
}

/* ===== Charts ===== */
function drawChart(s){
  const {ctx,W,H,buf} = s; if(!ctx) return;
  ctx.clearRect(0,0,W,H);
  ctx.globalAlpha=.15; ctx.strokeStyle='#9aa3b2'; ctx.lineWidth=1;
  for(let i=1;i<5;i++){ const y=H*i/5; ctx.beginPath(); ctx.moveTo(0,Math.round(y)+.5); ctx.lineTo(W,Math.round(y)+.5); ctx.stroke(); }
  ctx.globalAlpha=1;
  const step = W/(buf.length-1); ctx.beginPath();
  for(let i=0;i<buf.length;i++){
    const v = Math.max(0, Math.min(1, buf[i]/maxKg));
    const x = i*step, y = H - v*H;
    if(i){ ctx.lineTo(x,y); } else { ctx.moveTo(x,y); }
  }
  ctx.lineWidth=2; ctx.strokeStyle='#6aa6ff'; ctx.stroke();
}

/* ===== Ingesta + suavizado ===== */
function pushSample(s, rawVal){
  const prev = s.vkg;
  s.kg = rawVal;
  s.vkg = s.vkg + EMA_ALPHA * (rawVal - s.vkg);
  const d = Math.abs(s.vkg - prev);
  s.dRecent.push(d); if(s.dRecent.length>60) s.dRecent.shift();

  s.buf.push(s.vkg); if(s.buf.length>200) s.buf.shift();
  drawChart(s);

  if(s.vkg < s.min) s.min = s.vkg;
  if(s.vkg > s.max) s.max = s.vkg;

  s.samples++; const now = performance.now();
  if(now - s.lastHzTs >= 1000){ s.samples=0; s.lastHzTs = now; }

  if(vS1 && vS2 && vS3 && vS4){
    vS1.textContent = (sensors[0]?.vkg||0).toFixed(2);
    vS2.textContent = (sensors[1]?.vkg||0).toFixed(2);
    vS3.textContent = (sensors[2]?.vkg||0).toFixed(2);
    vS4.textContent = (sensors[3]?.vkg||0).toFixed(2);
  }

  markHeatDirty();
  markProfileDirty();
}

/* ===== WebSocket & demo ===== */
function handleMessage(obj){
  if(typeof obj.kg === 'number'){ pushSample(sensors[0], +obj.kg); return; }
  if(Array.isArray(obj.s)){ for(let i=0;i<Math.min(N,obj.s.length);i++){ pushSample(sensors[i], Number(obj.s[i])||0); } return; }
  let used=false;
  for(let i=0;i<N;i++){ const k=`kg${i+1}`; if(typeof obj[k]==='number'){ pushSample(sensors[i], +obj[k]); used=true; } }
  if(used) return;
  if(typeof obj.ch==='number' && typeof obj.kg==='number'){ const idx=Math.max(0,Math.min(N-1,obj.ch|0)); pushSample(sensors[idx], +obj.kg); }
}
function connectWS(){
  const ip = ipEl.value.trim(); if(!ip){ alert('Ingresa la IP de la ESP32'); return; }
  localStorage.setItem('espIp', ip);
  const scheme = (location.protocol === 'https:') ? 'wss' : 'ws';
  try{ ws = new WebSocket(`${scheme}://${ip}/ws`); }catch(e){ setStatus(false,'Error'); return; }
  ws.onopen = ()=> setStatus(true,'Conectado');
  ws.onerror= ()=> setStatus(false,'Error');
  ws.onclose= ()=> setStatus(false,'Desconectado');
  ws.onmessage = (e)=>{ try{ handleMessage(JSON.parse(e.data)); }catch{} };
}
function disconnectWS(){ if(ws){ ws.close(); ws=null; } setStatus(false,'Desconectado'); }

/* ===== Comando vibrador hacia la LilyGO ===== */
function sendVib(active){
  if (!ws || ws.readyState !== WebSocket.OPEN) return;
  const desired = !!active;
  if (desired === vibOn) return;
  vibOn = desired;
  try {
    ws.send(JSON.stringify({ vib: desired ? 1 : 0 }));
  } catch(e){
    // ignorar error de envío
  }
}

/* ===== DEMO ===== */
function startDemo(){
  stopDemo(); setStatus(true,'Demo');
  const baseHz = 22;
  let last = performance.now();
  const t0 = performance.now();
  let lockedBias = 0;

  function tick(now){
    demoRAF = requestAnimationFrame(tick);
    if (now - last < 1000/baseHz) return;
    last = now;

    const t = (now - t0) / 1000;

    const base = 0.35 * maxKg;
    let ramp = 0;
    if (t <= 10) ramp = 0;
    else if (t <= 15) ramp = (t - 10) / 5;
    else ramp = 1;

    const fBias = (0.44 * maxKg) * ramp;
    if (t > 15 && lockedBias === 0) lockedBias = fBias;

    const lr = Math.sin(t * 0.6) * (0.03 * maxKg);
    const noise = () => (Math.random() - 0.5) * (0.02 * maxKg);
    const bias = (t > 15) ? lockedBias : fBias;

    const vals = [
      Math.max(0, base +  bias/2 - lr/2 + noise()), // S1
      Math.max(0, base +  bias/2 + lr/2 + noise()), // S2
      Math.max(0, base -  bias/2 - lr/2 + noise()), // S3
      Math.max(0, base -  bias/2 + lr/2 + noise()), // S4
    ];
    for (let i=0; i<4; i++) pushSample(sensors[i], vals[i]);
  }
  demoRAF = requestAnimationFrame(tick);
}
function stopDemo(){ if(demoRAF){ cancelAnimationFrame(demoRAF); demoRAF=0; } }

/* ===== Paleta ámbar para mapa ===== */
function hslToRgb(h,s,l){
  s/=100; l/=100;
  const c=(1-Math.abs(2*l-1))*s, x=c*(1-Math.abs(((h/60)%2)-1)), m=l-c/2;
  let r=0,g=0,b=0;
  if(h<60){r=c;g=x;} else if(h<120){r=x;g=c;} else if(h<180){g=c;b=x;}
  else if(h<240){g=x;b=c;} else if(h<300){r=x;b=c;} else {r=c;b=x;}
  return [Math.round((r+m)*255),Math.round((g+m)*255),Math.round((b+m)*255)];
}
function amberRGB(t){
  t = Math.max(0, Math.min(1, t));
  const h = 42, s = 25 + 70*t, l = 14 + 50*Math.pow(t,0.85);
  return hslToRgb(h,s,l);
}

/* ===== Heatmap (4 cuadrados independientes) ===== */
let heatCtx = heatCvs.getContext('2d');
let heatW=0, heatH=0, heatDirty=true, lastHeatTs=0;
function roundRectPath(ctx, x,y,w,h,r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y,  x+w,y+h, rr);
  ctx.arcTo(x+w,y+h,x,y+h, rr);
  ctx.arcTo(x,y+h,  x,y, rr);
  ctx.arcTo(x,y,    x+w,y, rr);
  ctx.closePath();
}
function drawTile(ctx, x,y, w,h, value, label, pos='below'){
  const t = Math.max(0, Math.min(1, value/maxKg));
  const [r,g,b] = amberRGB(t);
  ctx.save();
  roundRectPath(ctx,x,y,w,h,TILE_RADIUS);
  ctx.fillStyle = `rgb(${r},${g},${b})`;
  ctx.fill(); ctx.clip();
  const grd = ctx.createLinearGradient(x,y,x,y+h);
  grd.addColorStop(0,'rgba(255,255,255,0.10)');
  grd.addColorStop(0.6,'rgba(0,0,0,0.00)');
  grd.addColorStop(1,'rgba(0,0,0,0.20)');
  ctx.fillStyle = grd; ctx.fillRect(x,y,w,h);
  ctx.restore();
  ctx.strokeStyle='rgba(255,255,255,0.10)';
  ctx.lineWidth=1.2;
  roundRectPath(ctx,x,y,w,h,TILE_RADIUS); ctx.stroke();
  const fs = Math.max(16, Math.min(20, Math.round(w*0.13)));
  ctx.font = `700 ${fs}px ui-sans-serif, system-ui`;
  ctx.fillStyle = 'rgba(255,255,255,0.96)';
  ctx.textAlign = 'center';
  if(pos==='above'){
    ctx.textBaseline = 'bottom';
    ctx.fillText(`${label} ${value.toFixed(2)} kg`, Math.round(x + w/2)+.5, Math.round(y - 8)+.5);
  }else{
    ctx.textBaseline = 'top';
    ctx.fillText(`${label} ${value.toFixed(2)} kg`, Math.round(x + w/2)+.5, Math.round(y + h + 12)+.5);
  }
}
function drawHeatmap(force=false){
  const now = performance.now();
  if(!force && now - lastHeatTs < 60) return;
  lastHeatTs = now; heatDirty=false;

  const ctx = heatCtx, W = heatW, H = heatH; ctx.clearRect(0,0,W,H);
  const x0 = HEAT_PAD, y0 = HEAT_PAD + LABEL_TOP;
  const w = W - HEAT_PAD*2;
  const h = H - HEAT_PAD*2 - LABEL_TOP - LABEL_BOTTOM;
  roundRectPath(ctx, x0, y0, w, h, HEAT_RADIUS);
  ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.stroke();

  const gap = TILE_GAP;
  const tw = (w - gap)/2;
  const th = (h - gap)/2;

  const v1 = sensors[0]?.vkg||0;
  const v2 = sensors[1]?.vkg||0;
  const v3 = sensors[2]?.vkg||0;
  const v4 = sensors[3]?.vkg||0;

  drawTile(ctx, x0,          y0,          tw, th, v1, 'S1', 'above');
  drawTile(ctx, x0+tw+gap,   y0,          tw, th, v2, 'S2', 'above');
  drawTile(ctx, x0,          y0+th+gap,   tw, th, v3, 'below');
  drawTile(ctx, x0+tw+gap,   y0+th+gap,   tw, th, v4, 'below');
}

/* ===== PERFIL: análisis, alarma 10s y CoP ===== */
let profileDirty = true;

/* Estados de alarma */
let fwdState = 'idle';    // 'idle' | 'warn' | 'alarm'
let fwdEnterAt = 0;       // ms cuando entró a “Muy adelante”
let fwdExitAt = 0;        // ms inicio de salida
const ALARM_AFTER = 10_000;    // 10s
const EXIT_DEBOUNCE = 1_500;   // 1.5s para reset estable

function setBars(lrPos, fbPos){
  const lrPerc = Math.round(lrPos*100);
  const fbPerc = Math.round(fbPos*100);
  if(barLR){ barLR.style.width = `${lrPerc}%`; barLR.className = 'inner ' + (lrPos>=0.5?'right':'left'); }
  if(barFB){ barFB.style.width = `${fbPerc}%`; barFB.className = 'inner ' + (fbPos>=0.5?'front':'back'); }
}
function setConclusion(text, subtitle, kind){
  if(conclusionEl) conclusionEl.textContent = text;
  if(conclusionBadgeEl){
    if(!subtitle){ conclusionBadgeEl.innerHTML=''; return; }
    const cls = kind==='bad'?'badge-bad':kind==='warn'?'badge-warn':'badge-ok';
    conclusionBadgeEl.innerHTML = `<span class="${cls}">${subtitle}</span>`;
  }
}
/* Visual de la alarma/pastilla */
function showFwdWarn(elapsedMs){
  const s = Math.floor(elapsedMs/1000);
  fwdTimerPill.style.display = 'inline-flex';
  fwdTimerPill.className = 'pill warn';
  fwdTimerPill.textContent = `Adelantado • ${s}s`;
  fwdTimerPill.classList.remove('blink');
}

/* Al entrar a alarma: también enciende vibrador */
function triggerFwdAlarm(){
  fwdState = 'alarm';
  fwdTimerPill.style.display = 'inline-flex';
  fwdTimerPill.className = 'pill alarm blink';
  fwdTimerPill.textContent = `¡Muy adelante! • 10s`;

  // Encender vibrador en la LilyGO
  sendVib(true);
}

function updateFwdAlarmElapsed(elapsedMs){
  const s = Math.floor(elapsedMs/1000);
  fwdTimerPill.textContent = `¡Muy adelante! • ${s}s`;
}

/* Al resetear la alerta: apaga vibrador */
function resetFwdAlert(){
  fwdState = 'idle';
  fwdEnterAt = 0;
  fwdExitAt = 0;
  fwdTimerPill.style.display = 'none';
  fwdTimerPill.className = 'pill';
  fwdTimerPill.classList.remove('blink');

  // Apagar vibrador al salir de la zona roja
  sendVib(false);
}

function computeProfile(){
  const s1 = sensors[0]?.vkg||0;
  const s2 = sensors[1]?.vkg||0;
  const s3 = sensors[2]?.vkg||0;
  const s4 = sensors[3]?.vkg||0;
  const total = s1+s2+s3+s4;

  if(kpiTotal) kpiTotal.textContent = total.toFixed(2);

  // Estabilidad (promedio de cambios recientes)
  let mov = 0;
  for(const s of sensors){ if(s.dRecent.length){ mov += s.dRecent.reduce((a,b)=>a+b,0)/s.dRecent.length; } }
  mov = mov/Math.max(1,sensors.length);
  const movN = Math.min(1, mov/(maxKg*0.03));
  if(kpiStab) kpiStab.textContent = movN<0.25 ? 'Alta' : movN<0.6 ? 'Media' : 'Baja';

  if(total < Math.max(0.6, maxKg*0.06)){ // sin carga
    setConclusion('Sin carga','', 'ok');
    setBars(0.5,0.5);
    drawCoP(0.5,0.5,false);
    resetFwdAlert();
    if(inlineLRFB) inlineLRFB.textContent = 'Centro • Centro';
    if(txtLR) txtLR.textContent = '—';
    if(txtFB) txtFB.textContent = '—';
    return;
  }

  const left  = s1 + s3;
  const right = s2 + s4;
  const front = s1 + s2;
  const back  = s3 + s4;

  const lr = (right - left) / total;  // + derecha, - izquierda
  const fb = (front - back) / total;  // + adelante, - atrás

  const lrAbs = Math.abs(lr), fbAbs = Math.abs(fb);

  // UMBRALES
  const TH_SOFT = 0.25, TH_STRONG = 0.50;

  let txtLRv = 'Centro';
  if(lr > TH_STRONG) txtLRv = 'Muy a la derecha';
  else if(lr > TH_SOFT) txtLRv = 'Leve a la derecha';
  else if(lr < -TH_STRONG) txtLRv = 'Muy a la izquierda';
  else if(lr < -TH_SOFT) txtLRv = 'Leve a la izquierda';

  let txtFBv = 'Centro';
  if(fb > TH_STRONG) txtFBv = 'Muy adelante';
  else if(fb > TH_SOFT) txtFBv = 'Leve adelante';
  else if(fb < -TH_STRONG) txtFBv = 'Muy atrás';
  else if(fb < -TH_SOFT) txtFBv = 'Leve atrás';

  if(txtLR) txtLR.textContent = `${txtLRv} (${(lr*100).toFixed(0)}%)`;
  if(txtFB) txtFB.textContent = `${txtFBv} (${(fb*100).toFixed(0)}%)`;
  if(inlineLRFB){ inlineLRFB.textContent = `${txtLRv} • ${txtFBv}`; }

  const toHalf = (v)=> Math.max(0, Math.min(1, 0.5 + v/2));
  setBars(toHalf(lr), toHalf(fb));

  let conclusion = 'Bien sentado';
  let badgeKind = 'ok';
  if(lrAbs>TH_STRONG || fbAbs>TH_STRONG){ conclusion = 'Necesita corrección'; badgeKind='bad'; }
  else if(lrAbs>TH_SOFT || fbAbs>TH_SOFT){ conclusion = 'Ligeramente desbalanceado'; badgeKind='warn'; }

  const dir = (()=>{
    if(lrAbs>=fbAbs){
      if(lr>TH_SOFT) return ' (a la derecha)';
      if(lr<-TH_SOFT) return ' (a la izquierda)';
    }else{
      if(fb>TH_SOFT) return ' (hacia adelante)';
      if(fb<-TH_SOFT) return ' (hacia atrás)';
    }
    return '';
  })();
  setConclusion(conclusion+dir, txtLRv+' • '+txtFBv, badgeKind);

  // Alarma 10s “Muy adelante”
  const nowMs = performance.now();
  if (fb > TH_STRONG) {
    if (fwdState === 'idle') {
      fwdState = 'warn';
      fwdEnterAt = nowMs;
      fwdExitAt = 0;
      showFwdWarn(0);
    } else if (fwdState === 'warn') {
      const elapsed = nowMs - fwdEnterAt;
      if (elapsed >= ALARM_AFTER) {
        triggerFwdAlarm();
      } else {
        showFwdWarn(elapsed);
      }
    } else if (fwdState === 'alarm') {
      const elapsed = nowMs - fwdEnterAt;
      updateFwdAlarmElapsed(elapsed);
    }
  } else if (fb <= TH_SOFT) {
    if (fwdState === 'warn' || fwdState === 'alarm') {
      if (fwdExitAt === 0) fwdExitAt = nowMs;
      if (nowMs - fwdExitAt >= EXIT_DEBOUNCE) {
        resetFwdAlert();
      } else {
        if (fwdState === 'warn') showFwdWarn(nowMs - fwdEnterAt);
        else updateFwdAlarmElapsed(nowMs - fwdEnterAt);
      }
    }
  } else {
    if (fwdState === 'warn') showFwdWarn(nowMs - fwdEnterAt);
    if (fwdState === 'alarm') updateFwdAlarmElapsed(nowMs - fwdEnterAt);
  }

  const x = right/Math.max(1e-6,(left+right));
  const y = front/Math.max(1e-6,(front+back));
  drawCoP(x,y,true);
}

function drawCoP(x,y,hasLoad){
  const ctx=copCtx, W=copCvs.width/DPR, H=copCvs.height/DPR;
  ctx.setTransform(DPR,0,0,DPR,0,0);
  ctx.clearRect(0,0,W,H);

  const pad=14, r=12, x0=pad, y0=pad, w=W-pad*2, h=H-pad*2;
  roundRectPath(ctx,x0,y0,w,h,r);
  ctx.strokeStyle='rgba(255,255,255,0.08)'; ctx.stroke();

  ctx.globalAlpha=0.25; ctx.strokeStyle='#0b1020'; ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(Math.round(x0+w/2)+.5, y0);   ctx.lineTo(Math.round(x0+w/2)+.5, y0+h);
  ctx.moveTo(x0, Math.round(y0+h/2)+.5);   ctx.lineTo(x0+w, Math.round(y0+h/2)+.5);
  ctx.stroke(); ctx.globalAlpha=1;

  const gap=10, tw=(w-gap)/2, th=(h-gap)/2;
  const vals=[sensors[0]?.vkg||0, sensors[1]?.vkg||0, sensors[2]?.vkg||0, sensors[3]?.vkg||0];
  const boxes=[[x0,y0],[x0+tw+gap,y0],[x0,y0+th+gap],[x0+tw+gap,y0+th+gap]];
  for(let i=0;i<4;i++){
    const t=Math.max(0,Math.min(1, vals[i]/maxKg));
    const [r,g,b]=amberRGB(t);
    ctx.fillStyle=`rgba(${r},${g},${b},0.5)`;
    roundRectPath(ctx, boxes[i][0], boxes[i][1], tw, th, 10);
    ctx.fill();
  }

  if(hasLoad){
    const cx = x0 + x*w;
    const cy = y0 + (1-y)*h;
    ctx.shadowColor='rgba(0,0,0,0.35)'; ctx.shadowBlur=6;
    ctx.fillStyle='#ffffff'; ctx.beginPath(); ctx.arc(cx,cy,6,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;
  }else{
    ctx.fillStyle='#9aa3b2'; ctx.font='13px system-ui';
    ctx.fillText('Sin carga', x0+8, y0+18);
  }

  ctx.fillStyle='#9aa3b2'; ctx.font='12px system-ui';
  ctx.fillText('S1', x0+8, y0+14);
  ctx.fillText('S2', x0+tw+gap+8, y0+14);
  ctx.fillText('S3', x0+8, y0+th+gap+14);
  ctx.fillText('S4', x0+tw+gap+8, y0+th+gap+14);
}

/* ===== Resize ===== */
function resizeAllCanvases(){
  sensors.forEach(s=>{
    if(!s.cvs) return;
    const parentW = Math.floor(s.cvs.parentElement.clientWidth);
    const cssW = Math.max(320, Math.min(CHART_MAX_PX, parentW));
    const cssH = Math.round(cssW * 0.4);
    const {ctx,W,H} = setupCanvas(s.cvs, cssW, cssH);
    s.ctx=ctx; s.W=W; s.H=H; drawChart(s);
  });

  if(heatCvs){
    const wrapW = Math.floor(heatCvs.parentElement.clientWidth);
    const cssW = Math.max(300, Math.min(HEAT_MAX_PX, wrapW));
    const cssH = cssW + LABEL_TOP + LABEL_BOTTOM + 12;
    const obj = setupCanvas(heatCvs, cssW, cssH);
    heatCtx = obj.ctx; heatW = obj.W; heatH = obj.H;
    heatCvs.style.margin = '0 auto';
    if(currentView==='heatmap') drawHeatmap(true);
  }

  if(copCvs){
    const parentW = Math.floor(copCvs.parentElement.clientWidth);
    const cssW = Math.max(260, Math.min(460, parentW));
    const cssH = cssW;
    const {ctx} = setupCanvas(copCvs, cssW, cssH);
    copCtx = ctx;
    if(currentView==='profile') { profileDirty = true; computeProfile(); }
  }
}

/* ===== Loops ===== */
(function heatLoop(){
  requestAnimationFrame(heatLoop);
  if(currentView==='heatmap' && heatDirty) drawHeatmap();
})();
function markHeatDirty(){ if(currentView==='heatmap') heatDirty = true; }

(function profileLoop(){
  requestAnimationFrame(profileLoop);
  if(currentView==='profile' && profileDirty) { computeProfile(); profileDirty=false; }
})();
function markProfileDirty(){ if(currentView==='profile') profileDirty = true; }

/* ===== Vistas ===== */
function setActive(btn){
  [btnProfile,btnDashboard,btnHeatmap,btnGuide].forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
function showProfile(){
  profileSec.style.display='block';
  dashboardSec.style.display='none';
  heatmapSection.style.display='none';
  guideSec.style.display='none';
  currentView='profile'; setActive(btnProfile);
  resizeAllCanvases(); profileDirty=true;
}
function showDashboard(){
  profileSec.style.display='none';
  dashboardSec.style.display='';
  heatmapSection.style.display='none';
  guideSec.style.display='none';
  currentView='dashboard'; setActive(btnDashboard);
  resizeAllCanvases();
}
function showHeatmap(){
  profileSec.style.display='none';
  dashboardSec.style.display='none';
  heatmapSection.style.display='block';
  guideSec.style.display='none';
  currentView='heatmap'; setActive(btnHeatmap);
  resizeAllCanvases(); drawHeatmap(true);
}
function showGuide(){
  profileSec.style.display='none';
  dashboardSec.style.display='none';
  heatmapSection.style.display='none';
  guideSec.style.display='block';
  currentView='guide'; setActive(btnGuide);
  resizeAllCanvases();
}

/* ===== FX Portada: blobs ===== */
let fxCtx2=null, fxW=0, fxH=0, fxRAF=0; const BLOBS=7; const blobs=[];
function setupFX(){
  if(!bgfx) return;
  const rect=bgfx.getBoundingClientRect();
  bgfx.width=Math.round(rect.width*DPR);
  bgfx.height=Math.round(rect.height*DPR);
  bgfx.style.width=rect.width+'px';
  bgfx.style.height=rect.height+'px';
  fxCtx2=bgfx.getContext('2d');
  fxCtx2.setTransform(DPR,0,0,DPR,0,0);
  fxW=rect.width; fxH=rect.height;
  blobs.length=0;
  for(let i=0;i<BLOBS;i++){
    blobs.push({
      x: Math.random()*fxW,
      y: Math.random()*fxH,
      baseR: 140 + Math.random()*200,
      ampR:  40 + Math.random()*80,
      vx: (Math.random()*2 - 1) * 0.15 * FX_DRIFT,
      vy: (Math.random()*2 - 1) * 0.15 * FX_DRIFT,
      hue: i%2 ? 210 : 42,
      sat: i%2 ? 70  : 90,
      baseA: 0.05 + Math.random()*0.10,
      ampA:  0.08 + Math.random()*0.20,
      phase: Math.random()*Math.PI*2,
      speed: (0.006 + Math.random()*0.010) * FX_SPEED
    });
  }
}
function tickFX(){
  fxRAF=requestAnimationFrame(tickFX);
  if(!fxCtx2) return;
  fxCtx2.clearRect(0,0,fxW,fxH);
  fxCtx2.globalCompositeOperation='lighter';
  for(const b of blobs){
    b.phase += b.speed;
    const a = Math.max(0, Math.min(1, b.baseA + b.ampA*(0.5+0.5*Math.sin(b.phase))));
    const r = Math.max(20, b.baseR + b.ampR*(0.5+0.5*Math.sin(b.phase*0.9+0.7)));
    const grd=fxCtx2.createRadialGradient(b.x,b.y,0,b.x,b.y,r);
    const c1=`hsla(${b.hue} ${b.sat}% 55% / ${a})`;
    const c0=`hsla(${b.hue} ${b.sat}% 55% / 0)`;
    grd.addColorStop(0,c1); grd.addColorStop(1,c0);
    fxCtx2.fillStyle=grd; fxCtx2.beginPath(); fxCtx2.arc(b.x,b.y,r,0,Math.PI*2); fxCtx2.fill();
    b.x+=b.vx; b.y+=b.vy;
    if(b.x<-120||b.x>fxW+120) b.vx*=-1;
    if(b.y<-120||b.y>fxH+120) b.vy*=-1;
  }
  fxCtx2.globalCompositeOperation='source-over';
}
window.addEventListener('resize', ()=>{ if(landing && landing.style.display!=='none'){ setupFX(); } resizeAllCanvases(); });

/* ===== Navegación ===== */
function gotoApp(){
  landing.style.display='none'; app.style.display='block';
  if(LOGO_PATH){ cornerLogo.src=LOGO_PATH; cornerLogo.style.display='block'; }
  renderUI();
  const now = performance.now();
  sensors.forEach(s=>{
    s.lastHzTs=now; s.samples=0; s.min=Infinity; s.max=-Infinity; s.buf.fill(0);
    s.kg=0; s.vkg=0; s.dRecent.length=0;
  });
  showProfile();
}
function goLogout(){
  disconnectWS(); stopDemo();
  app.style.display='none'; landing.style.display='grid'; cornerLogo.style.display='none';
  userEl.value=''; passEl.value=''; loginErr.textContent=''; loginCard.style.display='flex';
  setupFX(); if(!fxRAF) tickFX();
}

/* ===== Eventos UI ===== */
btnShowLogin.onclick = ()=>{ loginCard.style.display='flex'; userEl.focus(); };
btnDemo.onclick = ()=>{ loginCard.style.display='none'; gotoApp(); startDemo(); setStatus(true,'Demo'); };
btnLogin.onclick = ()=>{
  const u=(userEl.value||'').trim(), p=passEl.value||'';
  loginErr.textContent='';
  if(!VALID_USERS.has(u)){ loginErr.textContent='Usuario no autorizado.'; return; }
  if(p!==u){ loginErr.textContent='Contraseña inválida.'; return; }
  gotoApp();
};
// CapsLock + Enter
passEl.addEventListener('keyup', (e)=>{
  const on = e.getModifierState && e.getModifierState('CapsLock');
  capsEl.style.display = on? 'inline' : 'none';
  if(e.key==='Enter') btnLogin.click();
});
userEl.addEventListener('keyup', (e)=>{ if(e.key==='Enter') passEl.focus(); });

// Nav
btnProfile.onclick   = showProfile;
btnDashboard.onclick = showDashboard;
btnHeatmap.onclick   = showHeatmap;
btnGuide.onclick     = showGuide;

// Conexión
btnConnect.onclick=()=>{ stopDemo(); connectWS(); };
btnDisconnect.onclick=()=>{ disconnectWS(); };
document.getElementById('btnLogout').onclick = goLogout;
maxkgEl.addEventListener('input', ()=>{
  const v=Math.max(0.1, parseFloat(maxkgEl.value)||10);
  maxKg = v; localStorage.setItem('maxKg', v.toFixed(1));
  sensors.forEach(drawChart);
  if(currentView==='heatmap') drawHeatmap(true);
  if(currentView==='profile') profileDirty=true;
});

/* ===== Init ===== */
function renderUI(){
  // cards
  cardsEl.innerHTML = sensors.map(s=>`
    <div class="card" id="card-${s.id}" role="region" aria-label="Indicadores del ${s.label}">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="label">Sensor</div><div class="label">${s.label}</div>
      </div>
      <div class="value" id="kg-${s.id}" aria-live="polite">0.000</div>
      <div class="bar" aria-hidden="true"><div class="fill" id="fill-${s.id}" style="width:0%"></div></div>
      <div class="row">
        <div class="kpi">Mín: <b id="min-${s.id}">0.000</b> kg</div>
        <div class="kpi">Máx: <b id="max-${s.id}">0.000</b> kg</div>
        <div class="kpi">Hz: <b id="hz-${s.id}">0.0</b></div>
      </div>
    </div>
  `).join('');
  // charts
  chartsEl.innerHTML = sensors.map(s=>`
    <div class="chart" role="img" aria-label="Histórico ${s.label} de aproximadamente 20 segundos">
      <div class="label">Histórico ${s.label} (~20 s)</div>
      <canvas id="cv-${s.id}"></canvas>
    </div>
  `).join('');
  sensors.forEach(s=>{ s.cvs = document.getElementById(`cv-${s.id}`); });
  resizeAllCanvases();
}

// FX portada
setupFX();
tickFX();

/* (Duplicado intencional de markProfileDirty se mantiene igual que en tu versión)
function markProfileDirty(){ if(currentView==='profile') profileDirty = true; }
*/
</script>
</body>
</html>
